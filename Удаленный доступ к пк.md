# PC Remote Telegram Bot — подробное описание

Это утилита для **удалённого управления ПК через Telegram** с дополнительной **веб-панелью** (FastAPI), позволяющей видеть экран в реальном времени (MJPEG ~8 FPS) и управлять **мышью и клавиатурой** прямо из браузера.

---

## Возможности

### Через Telegram
- `/run <cmd>` — запуск программ/команд.
- `/kill <pid|name>` — завершение процессов по PID или по части имени.
- Отправка файлов боту — файл сохраняется на ПК в папку загрузок (`tg_remote`).
- `/screenshot` — скриншот текущего экрана.
- `/ps [filter]` — список процессов (с фильтром по подстроке).
- `/info` — краткая информация о системе.
- `/panel` — выдаёт **инлайн-кнопку** со ссылкой на **панель управления в браузере**.

### Через веб-панель
- Просмотр экрана (MJPEG) в реальном времени (~8 FPS, качество JPEG 60).
- Управление мышью: перемещение, клики (левая/правая/средняя), прокрутка.
- Управление клавиатурой: keydown/keyup для стандартных клавиш.
- Режим масштабирования: `Вписать` / `1:1`.

---

## Архитектура

- **Telegram-бот:** `python-telegram-bot 21.x`.
- **Захват экрана:** `mss` + `Pillow` → JPEG кадры.
- **Веб-сервер/панель:** `FastAPI` + `uvicorn`.
- **Управление вводом:** `pyautogui` (мышь/клава).
- **Безопасность:** временные **токены доступа** к панели (по умолчанию 30 мин), белый список **ALLOWED_USER_IDS** для Telegram-команд.

Стрим доступен по `GET /stream.mjpg`, события ввода идут по `WS /ws`. Панель доступна по `GET /remote?token=...`.

---

## Требования

- Python 3.10+ (проверено на Windows / Linux / macOS; на macOS потребуются разрешения Accessibility).
- Зависимости (минимальный набор):
  - `python-telegram-bot==21.4`
  - `psutil==6.0.0`
  - `mss==9.0.1`
  - `Pillow==10.4.0`
  - `platformdirs==4.3.6`
  - `fastapi==0.115.0`
  - `uvicorn==0.30.6`
  - `pyautogui==0.9.54`

---

## Установка и запуск

1. **Установите зависимости:**
   ```bash
   pip install python-telegram-bot==21.4 psutil==6.0.0 mss==9.0.1 Pillow==10.4.0 platformdirs==4.3.6 fastapi==0.115.0 uvicorn==0.30.6 pyautogui==0.9.54
   ```

2. **Настройте переменные окружения (опционально):**
   - `BOT_TOKEN` — токен вашего Telegram-бота (можно оставить встроенное значение, но небезопасно).
   - `ALLOWED_USER_IDS` — список разрешённых Telegram ID (через запятую).
   - `DOWNLOAD_DIR` — путь, куда сохранять присланные файлы.
   - `WEB_PORT` — порт веб-панели (по умолчанию `8765`).
   - `TOKEN_TTL` — время жизни токена веб-панели в секундах (по умолчанию `1800`).

3. **Запустите:**
   ```bash
   python bot.py
   ```

4. **Откройте панель:**
   - В Telegram отправьте боту команду `/panel`.
   - Нажмите **инлайн-кнопку** «Открыть панель управления» — откроется браузер по адресу вроде `http://<LAN-IP>:8765/remote?token=...`.
   - Важно: устройство должно быть **в той же сети (LAN)**, если не настроен внешний доступ.

---

## Конфигурация и переменные окружения

| Переменная | Назначение | По умолчанию |
|---|---|---|
| `BOT_TOKEN` | Токен Telegram-бота | — |
| `ALLOWED_USER_IDS` | Список разрешённых ID | — (в коде задан дефолт) |
| `DOWNLOAD_DIR` | Папка для сохранения файлов | `~/Downloads/tg_remote` |
| `WEB_PORT` | Порт веб-панели | `8765` |
| `TOKEN_TTL` | TTL токена веб-панели (сек) | `1800` |
| `LOG_LEVEL` | Уровень логирования | `INFO` |

---

## Команды Telegram

- **`/start`** — приветствие.
- **`/help`** — список команд.
- **`/info`** — сведения о системе.
- **`/run <команда>`** — запуск программы/команды.
- **`/kill <pid|часть_имени>`** — завершение процесса по PID или имени.
- **`/ps [filter]`** — список процессов, фильтр по подстроке.
- **`/screenshot`** — скриншот экрана.
- **`/panel`** — сгенерировать ссылку на веб-панель (инлайн-кнопка), токен действует ограниченное время.

---

## HTTP/WS API (внутреннее)

### `GET /remote?token=...`
Возвращает HTML страницу панели. Требует валидный токен.

### `GET /stream.mjpg?token=...`
Многокадровый MJPEG-поток экрана (границы: `multipart/x-mixed-replace`). Качество/частота настраиваются в коде.

### `WS /ws?token=...`
WebSocket-подключение для управляющих событий. Форматы сообщений:

**От сервера клиенту:**
```json
{ "type": "screen", "w": 1920, "h": 1080 }
```

**От клиента серверу:**
```json
{ "type": "move",  "x": 100, "y": 200 }
{ "type": "click", "button": "left" }   // left|right|middle
{ "type": "scroll","dx": 0, "dy": -1 }  // знак направления
{ "type": "key",   "action": "down", "key": "a" } // action: down|up
```

---

## Безопасность

- **Белый список Telegram ID** (`ALLOWED_USER_IDS`) — команды принимаются только от ваших ID.
- **Временные токены** для веб-панели (TTL по умолчанию 30 минут). Просроченные токены очищаются автоматически.
- **Рекомендуется** держать веб-панель внутри **LAN**. Для доступа из интернета используйте туннелирование (Cloudflare Tunnel/ngrok), включите **HTTPS**, а также добавьте **второй фактор** (PIN/пароль) — это легко добавить поверх существующего токен-контроля.
- Храните `BOT_TOKEN` вне кода — через переменные окружения.

> Управление мышью/клавиатурой даёт полный доступ к системе. Запускайте бота только на доверенных машинах/сетях.

---

## Производительность

- Частота кадров: ~8 FPS (настройка `await asyncio.sleep(1/8)`). Уменьшите паузу для большего FPS (растёт нагрузка на CPU/сеть).
- Качество JPEG: `quality=60`. Поднимите для более чёткой картинки (растёт трафик).
- MJPEG — простой и совместимый способ стрима, но более требовательный к полосе. Альтернативы: WebRTC/WS + h264/VP9 (сложнее, но эффективнее).

---

## Платформенные особенности

- **Windows:** работает из коробки. Для невсплывающего запуска GUI-приложений можно доработать `/run` (скрытый режим/`START /B`).  
- **macOS:** дайте приложению права *System Settings → Privacy & Security → Accessibility* для `pyautogui`.  
- **Linux:** на Wayland управление может быть ограничено; X11 обычно работает стабильнее.

---

## Тестирование

Лёгкие тесты встроены (не требуют запуска бота/веба). Запуск:

```bash
RUN_TESTS=1 python bot.py
```

Покрыто: парсинг `ALLOWED_USER_IDS`, формат таблицы `/ps`, токены панели, выбор LAN-IP.

---

## Частые проблемы (Troubleshooting)

- **`RuntimeError: This event loop is already running`** — не используйте `asyncio.run` для `run_polling()`. В текущем коде `main()` синхронный и вызывает `app.run_polling(...)` — так и оставьте.
- **Панель не открывается с телефона** — телефон не в той же сети, брандмауэр блокирует порт 8765, неверный токен (истёк — сгенерируйте `/panel` заново).
- **Нет управления на macOS** — проверьте права Accessibility.
- **Лаги видео** — увеличьте паузу/уменьшите качество, проверьте нагрузку CPU/сети.

---

## Доработки (опционально)

- HTTPS + базовая авторизация/PIN.
- Туннель во внешний интернет (Cloudflare Tunnel/ngrok).
- Кнопки спецклавиш (Ctrl, Alt, Win, Esc, стрелки) на панели.
- Файловый менеджер (просмотр/скачивание/удалённая загрузка).
- WebRTC-видеопоток вместо MJPEG.
- Режим «только просмотр».

---

## Лицензия и ответственность

Проект предоставляется «как есть». Используйте на свой страх и риск. Убедитесь, что соблюдаете корпоративные политики и законы вашей юрисдикции при удалённом доступе.
