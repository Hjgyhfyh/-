# Телеграм Бот для массового управления аккаунтами (Telethon)
**Описание:** Телеграм-бот на Python (библиотека Telethon) для управления несколькими аккаунтами Telegram. Позволяет одному пользователю привязывать несколько аккаунтов и выполнять от их имени действия: рассылку сообщений и вступление в чаты по ссылке.
## Возможности
1. **Авторизация пользователя.** Первый собеседник автоматически получает права администратора. Всего бот запоминает до 20 UID без повторного подтверждения.
2. **Главное меню.** Отображает список привязанных аккаунтов и кнопку «Добавить аккаунт». Если аккаунтов нет, показывается только кнопка добавления нового аккаунта.
3. **Добавление нового аккаунта.** Бот запрашивает номер телефона, API ID и API Hash. Затем отправляет код авторизации Telegram на указанный номер и предлагает ввести этот код (и пароль 2FA, если включён). При успешной авторизации аккаунт сохраняется (сообщение «Аккаунт успешно добавлен!»).
4. **Меню аккаунта.** После выбора аккаунта предоставляются опции:
   - «Отправить сообщение в чат» – отправить сообщение в выбранный чат/канал от имени этого аккаунта.
   - «Зайти по ссылке» – вступить в чат/канал по приглашению (ссылке).
   - «Назад» – возвращение к списку аккаунтов.
5. **Отправка сообщения в чат.** Бот запрашивает ссылку или @username чата, затем текст сообщения. Можно отправить несколько сообщений подряд; для окончания ввода отправляется команда `/done`. После этого бот присоединяется аккаунтом к чату (если ещё не в нём) и отправляет все сообщения с интервалом ~2 секунды. По завершении сообщает об успехе.
6. **Переход по ссылке.** Бот запрашивает ссылку-приглашение. Аккаунт переходит по этой ссылке (вступает в группу/канал). Результат (успех или ошибка) сообщается пользователю.
7. **Многопоточность и очередь.** Бот обрабатывает задачи асинхронно – можно запускать действия сразу на нескольких аккаунтах. Задачи для каждого аккаунта выполняются последовательно (каждый последующий запрос ставится в очередь, если предыдущий ещё выполняется). Это позволяет работать с десятками аккаунтов одновременно.
8. **Максимальная подача.** Массовое вступление всеми аккаунтами по переданной ссылке или пересланному сообщению.
9. **Ботер.** Рассылка личных сообщений или активация ботов по ссылке/ID.
10. **Реакции и просмотры.** Установка реакций и накрутка просмотров на постах.
11. **Чат спам.** Отправка заданного сообщения в указанный чат.
12. **Голосование.** Массовый выбор варианта в опросе.
13. **Режим онлайн.** Команда включает/выключает онлайн‑статус для всех аккаунтов.
14. **До 20 администраторов.** Бот автоматически запоминает до двадцати UID без повторной авторизации.
15. **Логирование в консоль.** Вся активность выводится в стандартный вывод для удобства отладки.
## Структура проекта
```
TelethonMultiAccountBot/
├── config.py        # Конфигурация (API_ID, API_HASH, BOT_TOKEN, DB_PATH, SESSION_DIR)
├── main.py          # Основной код бота (логика, обработка событий)
├── README.md        # Описание и инструкция
└── requirements.txt # Зависимости (Telethon)
```
При работе также создаются:
- **accounts.db** – база данных SQLite с сохранёнными аккаунтами.
- Папка **sessions/** – для файлов сессий Telethon (авторизация аккаунтов).
## Запуск
1. Установите зависимости: `pip install -r requirements.txt` (потребуется **Telethon**).
2. Создайте файл `.env` на основе `.env.example` и укажите `API_ID`, `API_HASH`, `BOT_TOKEN` и другие переменные.
3. Запустите `main.py`: `python main.py`.
4. В Telegram найдите своего бота (через @username) и нажмите «Start». Бот сразу предоставит доступ к меню.
5. После этого можно добавлять аккаунты и использовать функции.
## Использование
- При добавлении аккаунта убедитесь, что у вас под рукой устройство с этим номером (для получения кода Telegram).
- Отправляя сообщения через бота, соблюдайте правила Telegram, чтобы аккаунты не блокировали за спам.
## Пример
После запуска и добавления аккаунтов, предположим, вы привязали 2 номера. Главное меню покажет список:
```
Главное меню:
+11111111111
+22222222222
Добавить аккаунт
``` 
Нажав на номер (например, +11111111111), вы увидите:
```
Аккаунт +11111111111: выберите действие:
Отправить сообщение в чат
Зайти по ссылке
Назад
``` 
Выберите «Отправить сообщение в чат». Бот спросит ссылку на чат – отправьте, например, `https://t.me/joinchat/AAAA...`. Затем отправьте текст сообщения. Если нужно несколько сообщений, отправляйте их по одному. Введите `/done`, когда готовы. Бот начнёт отправку (и сразу вернёт вас в меню аккаунта). По завершении вы получите уведомление: 
```
Аккаунт +11111111111: отправка сообщений завершена.
```

## Веб‑панель

Бот можно запустить вместе с небольшим веб‑сервером FastAPI. Он предоставляет
путь `/login` для получения JWT‑токена и `/accounts` для просмотра сохранённых
аккаунтов. Настройки и демо‑пользователи описаны в `config.py`.

Запуск веб‑панели:

```bash
uvicorn webpanel:app --reload
```

## Детали кода

Ниже приведено краткое описание модулей и их основных функций.

### `main.py`
Содержит логику телеграм‑бота. Основные точки входа:
- `main()` – инициализация и запуск бота.
- `handler()` – главный обработчик входящих сообщений. Автоматически выдаёт права администратора и переключает состояния пользователя.
- `menu_main()` и `menu_acc()` – формируют клавиатуры с возможными действиями.
- Вспомогательные функции для отправки сообщений, подписки по ссылке и т.д. располагаются в теле файла и используют модуль `godli.core.sessions`.

### `godli/core/sessions.py`
Отвечает за управление клиентами Telethon:
- `reload_ram()` загружает сохранённые аккаунты из базы и запускает их сессии.
- `enqueue()` и внутренний `_done()` обеспечивают очередь задач для каждого аккаунта.
- `connect_if_needed()` подключает клиента при необходимости.
- `add_account_record()` добавляет запись об аккаунте в базу.
- функции `parse_chat`, `parse_bot`, `parse_msg` помогают распознавать ссылки.

### `godli/services/logger.py`
Простой асинхронный логгер:
- `start()` запускает фоновую задачу.
- `log_user()` и `log_bot()` добавляют сообщения в очередь.

### `godli/services/analytics.py`
Позволяет собирать статистику использования бота:
- `record(action)` увеличивает счётчик действий.
- `summary()` возвращает накопленную статистику.

### `godli/security.py`
Содержит функции для работы с TOTP, на данный момент не используются при входе в бота или веб‑панель, но остаются для возможных расширений.

### `webpanel.py`
Минимальное веб‑приложение на FastAPI:
- `create_token()` формирует JWT.
- `login()` выдаёт токен после проверки email и пароля.
- `get_current_user()` проверяет подпись токена.
- `list_accounts()` возвращает список привязанных номеров.
