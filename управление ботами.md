# Управление ботами — подробное описание программы

> Эта программа — Telegram‑клиент (userbot) на Python для *склейки двух файлов* и опциональной *сборки исполняемого файла через PyInstaller*. Она заменяет GUI‑версию на `customtkinter`, чтобы работать в окружениях без `tkinter`, и хранит авторизационную сессию локально.

---

## Содержание
- [Кратко](#кратко)
- [Возможности](#возможности)
- [Архитектура](#архитектура)
- [Установка](#установка)
- [Настройка окружения](#настройка-окружения)
- [Запуск](#запуск)
- [Команды](#команды)
- [Сценарий работы](#сценарий-работы)
- [Файлы и структура каталогов](#файлы-и-структура-каталогов)
- [Опции сборки PyInstaller](#опции-сборки-pyinstaller)
- [Обработка ошибок и логирование](#обработка-ошибок-и-логирование)
- [Тестирование](#тестирование)
- [Развёртывание (systemd, Docker)](#развёртывание-systemd-docker)
- [Безопасность](#безопасность)
- [Ограничения и нюансы](#ограничения-и-нюансы)
- [FAQ](#faq)
- [Планы расширения](#планы-расширения)

---

## Кратко
- **Назначение:** принять из чата Telegram *два файла*, слить их в один `*_merged.py`, рядом создать `*.pyinstall` (это тот же `.py` с альтернативным расширением), при необходимости собрать исполняемый файл через **PyInstaller** и отправить результаты обратно в чат.
- **Тип клиента:** *userbot* на базе **Telethon** (используется ваш аккаунт: `api_id`, `api_hash`, номер телефона). Сессия сохраняется в `tg_session.session`.
- **Причина отказа от GUI:** на части серверов/контейнеров отсутствует `tkinter` → старая GUI‑версия падала с `ModuleNotFoundError: No module named 'tkinter'`.

---

## Возможности
- Приём **двух** файлов (любых текстовых; авто‑детект кодировки: `utf‑8`, `utf‑8‑sig`, `cp1251`, `windows‑1251`, `latin‑1`).
- Склейка с добавлением заголовка и маркеров «начало/конец» каждого файла.
- Создание `*.pyinstall` рядом с итоговым `*_merged.py`.
- **Опционально:** сборка однофайлового бинарника через **PyInstaller** (`--onefile`, поддержка оконного режима, пользовательской иконки).
- Ответ пользователю прямо в чат: исходы и логи сборки прикрепляются как файлы.
- Память о состоянии диалога (ожидание файлов) ведётся по `sender_id`.

---

## Архитектура

### Основные компоненты
- **Telethon client** — авторизация userbot’а, хендлеры событий:
  - `/start`, `/help` — справка;
  - `/reset` — сброс состояния;
  - `/merge [параметры]` — подготовка к приёму файлов и запуск пайплайна;
  - обработчик входящих документов.
- **Состояние** (`PendingMerge`) на пользователя (`sender_id`):
  - `base_name` (имя результата),
  - `build_exe` (флаг сборки EXE/бинарника),
  - `windowed` (оконный режим),
  - `files` (список полученных файлов),
  - `icon` (иконка при сборке).
- **Чистые функции**:
  - `read_text_best_effort_bytes(data)`, `merge_contents(t1, t2, src1, src2)`, `write_text(...)`;
  - `run_pyinstaller(merged_py, out_dir, base, windowed, icon)` — обёртка над процессом PyInstaller + сбор логов.

### Поток данных
1. Пользователь отправляет `/merge base=demo build=1 windowed=1`.
2. Бот сохраняет состояние ожидания файлов.
3. Пользователь загружает **два файла** (и, опционально, иконку).
4. Бот склеивает, создаёт `*.pyinstall`, по желанию собирает бинарник, шлёт файлы и лог обратно.

---

## Установка
```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\\Scripts\\activate
pip install --upgrade pip
pip install telethon python-dotenv pyinstaller
```
> **Примечание:** PyInstaller нужен только если требуется сборка исполняемого файла.

---

## Настройка окружения
Создайте файл **.env** рядом со скриптом:
```env
TELEGRAM_API_ID=123456
TELEGRAM_API_HASH=0123456789abcdef0123456789abcdef
TELEGRAM_PHONE=+79990000000   # необязательно; можно ввести при первом запуске
```
Где `api_id` и `api_hash` берутся на https://my.telegram.org.

Сессия авторизации сохраняется локально в `tg_session.session`.

---

## Запуск
```bash
python tg_merge_bot.py
```
При первом запуске Telethon спросит код из Telegram (и при необходимости пароль 2FA). После этого сессия будет сохранена.

---

## Команды
- **`/start`** / **`/help`** — краткая инструкция.
- **`/reset`** — очистить состояние ожидания файлов.
- **`/merge [base=<имя>] [build=0|1] [windowed=1|0]`** — начать сессию склейки.
  - `base` — базовое имя результирующих файлов (по умолчанию `merged`).
  - `build` — 1 = собирать бинарник через PyInstaller; 0 = только склейка.
  - `windowed` — 1 = оконный режим (без консоли) для Windows/macOS; 0 = консольный.

**Пример:**
```
/merge base=demo build=1 windowed=1
```
После команды отправьте **два файла**. Если `build=1`, можно также прислать иконку `.ico`/`.icns`/`.png`.

---

## Сценарий работы
1. Введите `/merge base=report build=0` → бот ждёт два файла.
2. Перешлите `a.py` и `b.py` (порядок не важен).
3. Бот вернёт `report_merged.py` и `report.pyinstall`.
4. Если `build=1`, дополнительно пришлёт `pyinstaller.log` и бинарник из каталога `out/<ваш_id>/<timestamp>/dist/`.

---

## Файлы и структура каталогов
```
./tg_merge_bot.py               # основной скрипт
./tg_session.session            # локальная сессия Telethon
./out/<sender_id>/<timestamp>/  # артефакты задач пользователя
    ├─ <base>_merged.py
    ├─ <base>.pyinstall
    ├─ pyinstaller.log          # если была сборка
    └─ dist/                    # бинарники PyInstaller
```

---

## Опции сборки PyInstaller
- `--onefile` — одиночный исполняемый.
- `--noconsole` (Windows) / `--windowed` (macOS/Linux) при `windowed=1`.
- `--icon <путь>` — если была прислана иконка.
- Каталоги для сборки/артефактов — внутри `out/<...>/{build,spec,dist}`.

**Важно:** PyInstaller собирает под текущую ОС. Кросс‑компиляция не поддерживается штатно.

---

## Обработка ошибок и логирование
- Отсутствие `tkinter` не влияет на работу: GUI не используется.
- Если PyInstaller не установлен, в лог пишется подсказка `pip install pyinstaller`.
- Любые сообщения из PyInstaller агрегируются в `pyinstaller.log` и отправляются в чат.
- Ошибки скачивания файлов/неподдерживаемые типы сообщаются пользователю.

---

## Тестирование
Мини‑набор тестов уже включён в файл. Запуск без `pytest`:
```bash
RUN_TESTS=1 python tg_merge_bot.py
```
Или стандартно:
```bash
pip install pytest
pytest -q
```
Покрываются:
- корректность авто‑декодирования UTF‑8,
- структура объединённого текста (заголовки/разделители/источники),
- очистка базового имени результата.

> При необходимости можно расширить тесты: мокать `run_pyinstaller`, симулировать входящие документы, проверять раскладку каталогов и т. п.

---

## Развёртывание (systemd, Docker)

### systemd (Linux)
`/etc/systemd/system/tg-merge-bot.service`:
```ini
[Unit]
Description=Telegram Merge Bot (Telethon)
After=network-online.target

[Service]
Type=simple
WorkingDirectory=/opt/tg-merge-bot
Environment=PYTHONUNBUFFERED=1
ExecStart=/opt/tg-merge-bot/.venv/bin/python tg_merge_bot.py
Restart=on-failure
User=botuser
Group=botuser

[Install]
WantedBy=multi-user.target
```
```
sudo systemctl daemon-reload
sudo systemctl enable --now tg-merge-bot
```

### Docker (минимальный пример)
`Dockerfile`:
```dockerfile
FROM python:3.12-slim
WORKDIR /app
COPY tg_merge_bot.py /app/
COPY requirements.txt /app/
RUN pip install --no-cache-dir -r requirements.txt
# .env можно монтировать как секрет/volume
CMD ["python", "tg_merge_bot.py"]
```
`requirements.txt`:
```
telethon
python-dotenv
pyinstaller
```
Запуск:
```bash
docker build -t tg-merge-bot .
docker run --rm -it -v $(pwd)/out:/app/out --env-file .env tg-merge-bot
```

---

## Безопасность
- **Хранение секретов:** `api_id`, `api_hash`, номер телефона — в `.env`. Не коммитьте его в репозиторий.
- **Сессия Telethon:** файл `tg_session.session` — содержит токены авторизации. Храните в приватном месте, права доступа ограничьте.
- **Границы доступа:** userbot действует **от вашего имени**. Будьте осторожны, не запускайте в незнакомых группах.

---

## Ограничения и нюансы
- Размеры вложений могут ограничиваться настройками клиента/серверов и сетью.
- PyInstaller может потребовать дополнительные зависимости для сложных проектов (модули с нативными расширениями и т. п.).
- Иконки: используйте `.ico` (Windows) и `.icns` (macOS) для нативного результата; `.png` поддерживается, но не всегда идеально конвертируется.

---

## FAQ
**Зачем расширение `.pyinstall`?**  Это удобный способ пометить «склеенный исходник»; фактически это обычный `.py`.

**Можно ли прикладывать больше двух файлов?**  Сейчас — нет; бот берёт первые два. Модифицируется несложно.

**Можно ли делать кросс‑сборку (Linux → Windows)?**  В рамках PyInstaller — нет (без дополнительных инструментов/CI‑матрицы).

**Чем userbot отличается от Bot API?**  Userbot использует ваш аккаунт и может писать там, где вы можете. Bot API требует токен и добавления бота в чаты.

---

## Планы расширения
- Поддержка **Bot API** как альтернативного режима (через токен).
- Inline‑кнопки: вкл/выкл `windowed`, запрос иконки, повтор сборки.
- Поддержка **более двух** файлов и стратегий объединения (по алфавиту, по порядку загрузки и т. п.).
- Выбор «текстовая» vs «бинарная» склейка (без декодирования).
- Шаблоны заголовков и метаданных (автор, дата, комментарии).

---

> Если требуется изменить логику приёма/команд (например, собирать бинарник отдельной командой `/build`), дайте знать — добавим быстро.

